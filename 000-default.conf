# Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
# error, crit, alert, emerg.
# It is also possible to configure the loglevel for particular
# modules, e.g.
#LogLevel info ssl:warn
LoadModule auth_mellon_module /usr/lib/apache2/modules/mod_auth_mellon.so

<VirtualHost _default_:80>
  ServerAdmin webmaster@localhost
	DocumentRoot /var/www/html/

  BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

  ProxyRequests Off
  ProxyPass /secret/ !

  ProxyPass / https://127.0.0.1:8000/ retry=10
  ProxyPassReverse / https://127.0.0.1:8000/

  ErrorDocument 401 "\
  <html>\
  <title>Access Restricted</title>\
  <body>\
  <h1>Access is restricted to organizational users.</h1>\
  <p>\
  <a href=\"http://localhost:8080/simplesaml/\"><strong>Click here to login via single sign-on, or wait for 2 seconds to be redirected automatically.<strong></a><br /><br /><br /><br /><a href=\"/#noredirect\">Temporarily disable redirection.</a>if(window.location.hash == \"\") { window.setTimeout(function(){ window.location.href = \"/secret/endpoint/login?ReturnTo=\" + encodeURIComponent(window.location.pathname + window.location.search); }, 2000); }\
  </p>\
  </body>\
  </html>"

  <Location />
  MellonEnable "info"
  AuthType "Mellon"
  MellonVariable "cookie"
  MellonEnable "auth"
  MellonSamlResponseDump On
  MellonSPPrivateKeyFile /etc/apache2/mellon/urn_opengrok.key
  MellonSPCertFile /etc/apache2/mellon/urn_opengrok.cert
  MellonSPMetadataFile /etc/apache2/mellon/urn_opengrok.xml
  MellonIdpMetadataFile /etc/apache2/mellon/idp.xml

  MellonEndpointPath "/secret/endpoint"
  MellonSecureCookie on
  # session cookie duration; 43200(secs) = 12 hours
  MellonSessionLength 43200
  MellonVariable "proxyweb"
  MellonUser "NAME_ID"
  MellonDefaultLoginPath /
  MellonSamlResponseDump On

  Require valid-user
  Order allow,deny
  Allow from 10.20.30.0/24
  Allow from 10.10.110.66
  Satisfy any
  </Location>

  <Location /secret/endpoint>
  AuthType "Mellon"
  MellonEnable "auth"
  Order Deny,Allow
  Allow from all
  Satisfy Any
  </Location>
</VirtualHost>
